import{assocPath as e,mergeDeepRight as t,omit as r,dissoc as n,slice as o}from"ramda";import{fetch as i}from"whatwg-fetch";import a from"node-fetch";var s,E,u,c=function(){return c=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},c.apply(this,arguments)};function l(e,t,r,n){return new(r||(r=Promise))((function(o,i){function a(e){try{E(n.next(e))}catch(e){i(e)}}function s(e){try{E(n.throw(e))}catch(e){i(e)}}function E(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,s)}E((n=n.apply(e,t||[])).next())}))}function p(e,t){var r,n,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(E){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(r=1,n&&(o=2&s[0]?n.return:s[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,s[1])).done)return o;switch(n=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,n=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],n=0}finally{r=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,E])}}}function f(e,t,r){if(r||2===arguments.length)for(var n,o=0,i=t.length;o<i;o++)!n&&o in t||(n||(n=Array.prototype.slice.call(t,0,o)),n[o]=t[o]);return e.concat(n||Array.prototype.slice.call(t))}!function(e){e.CDEEBEE_REQUESTMANAGER_SHIFT="@@cdeebee/REQUESTMANAGER_SHIFT",e.CDEEBEE_REQUESTMANAGER_SET="@@cdeebee/REQUESTMANAGER_SET",e.CDEEBEE_ERRORHANDLER_SET="@@cdeebee/ERRORHANDLER_SET",e.CDEEBEE_ENTITY_CHANGE_FIELD="@@cdeebee/ENTITY_CHANGE_FIELD",e.CDEEBEE_ENTITY_UNSAFE_UPDATE_STORE="@@cdeebee/ENTITY_UNSAFE_UPDATE_STORE",e.CDEEBEE_RESET_ENTITY="@@cdeebee/RESET_ENTITY",e.CDEEBEE_SET_ENTITY="@@cdeebee/SET_ENTITY",e.CDEEBEEE_UPDATE="@@cdeebee/UPDATE",e.CDEEBEEE_DROP="@@cdeebee/DROP",e.CDEEBEEE_DROP_PATH="@@cdeebee/DROP_PATH",e.CDEEBEE_INTERNAL_ERROR="@@cdeebee/INTERNAL_ERROR",e.CDEEBEE_REQUEST_ABORTED="@@cdeebee/REQUEST_ABORTED",e.CDEEBEEE_DROP_REQUEST_BY_API_URL="@@cdeebee/DROP_REQUEST_BY_API_URL",e.CDEEBEEE_DROP_ERROR_BY_API_URL="@@cdeebee/DROP_ERROR_BY_API_URL",e.CHANGE_ROUTE="@@router/LOCATION_CHANGE"}(s||(s={})),function(e){e.NEW="NEW",e.EDITING="EDITING",e.NORMAL="NORMAL"}(E||(E={})),function(e){e.merge="merge",e.replace="replace"}(u||(u={}));var y,d=function(e){return r(["__entity","__state"],e)},_=function(e){return e.filter((function(e){return!e.requestCancel||(b(e),!1)}))},b=function(e){e.controller&&e.controller.abort instanceof Function&&e.controller.abort()},R=function(e){var t,r=(null===(t=null==e?void 0:e.__entity)||void 0===t?void 0:t.__state)||(null==e?void 0:e.__state);return r||E.NORMAL},v=function(e){return R(e)===E.NORMAL?(console.warn("reset works only in editing and new states"),e):d(e)},h=function(t,r,n){var o=t[r];if(R(o[n])===E.EDITING)return t;var i=e([r,n,"__entity"],o[n],t);return e([r,n,"__entity","__state"],E.EDITING,i)},T=function(t,r,n){for(var o=n||[],i=t,a=0;a<r.length;a++){var s=r[a];i=e(f(f([],o,!0),s.key,!0),s.value,i)}return i},O=function(e){var n=e.response;n.responseStatus;for(var o=function(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(n=Object.getOwnPropertySymbols(e);o<n.length;o++)t.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(e,n[o])&&(r[n[o]]=e[n[o]])}return r}(n,["responseStatus"]),i=e.cdeebee,a=e.mergeListStrategy,s=e.primaryKey,E=0,c=Object.keys(o);E<c.length;E++){var l=c[E],p={};if(o[l]instanceof Object&&o[l].hasOwnProperty(s)){for(var f=0,y=o[l].data;f<y.length;f++){var d=y[f];p[d[o[l][s]]]=d}a[l]===u.replace?o[l]=p:o[l]=t(i[l],p)}else null!==o[l]&&void 0!==o[l]&&"string"!=typeof o[l]||(o=r([l],o))}return o},D=Object.freeze({__proto__:null,dropRequestFromArray:_,requestCancel:b,checkNetworkActivity:function(e,t){if(!t||0===e.length)return!1;for(var r=t instanceof Array?t:[t],n=e.map((function(e){return e.api})),o=0;o<r.length;o+=1)if(n.includes(r[o]))return!0;return!1},getSubEntity:function(e){return Object.prototype.hasOwnProperty.call(e,"__entity")?e.__entity:e},getEntityState:R,insertEntity:function(e){return e.__state=E.NEW,e},commitEntity:function(e){return R(e)===E.NORMAL?(console.warn("commit works only in editing and new states"),e):d(e)},resetEntity:v,editEntity:h,batchingUpdate:T,defaultNormalize:O}),A={},g=function(t,n){void 0===t&&(t=A);var o=n.type,i=n.payload;switch(o){case s.CDEEBEEE_UPDATE:return c(c({},t),i.response);case s.CDEEBEE_ENTITY_CHANGE_FIELD:var a=h(t,i.entityList,i.entityID);return T(a,i.valueList,[i.entityList,i.entityID,"__entity"]);case s.CDEEBEE_ENTITY_UNSAFE_UPDATE_STORE:return e([i.entityList,i.entityID],i.value,t);case s.CDEEBEE_SET_ENTITY:return e([i.entityList,i.entityID],i.entity,t);case s.CDEEBEE_RESET_ENTITY:var E=t[i.entityList];return e([i.entityList,i.entityID],v(E[i.entityID]),t);case s.CDEEBEEE_DROP:return A;case s.CDEEBEEE_DROP_PATH:return r(i.path,t);default:return t}},S={activeRequest:[],requestByApiUrl:{},errorHandler:{}},m=function(e,t){var r,i;void 0===e&&(e=S);var a=t.type,E=t.payload;switch(a){case s.CDEEBEE_REQUESTMANAGER_SET:return c(c({},e),{activeRequest:f(f([],e.activeRequest,!0),[E],!1)});case s.CDEEBEE_REQUESTMANAGER_SHIFT:return c(c({},e),{activeRequest:o(1,1/0,e.activeRequest)});case s.CDEEBEEE_UPDATE:return c(c({},e),{requestByApiUrl:c(c({},e.requestByApiUrl),(r={},r[E.api]=E.cleanResponse,r))});case s.CDEEBEEE_DROP_REQUEST_BY_API_URL:return c(c({},e),{requestByApiUrl:n(E.api,e.requestByApiUrl)});case s.CDEEBEEE_DROP_ERROR_BY_API_URL:return c(c({},e),{errorHandler:n(E.api,e.errorHandler)});case s.CDEEBEE_ERRORHANDLER_SET:return c(c({},e),{errorHandler:c(c({},e.errorHandler),(i={},i[E.api]=E.cleanResponse,i))});case s.CDEEBEE_INTERNAL_ERROR:return c(c({},e),{activeRequest:[],requestByApiUrl:{}});case s.CHANGE_ROUTE:return c(c({},S),{activeRequest:_(e.activeRequest)});default:return e}};y=function(){function e(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function t(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function r(e,r,n){return r&&t(e.prototype,r),n&&t(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function n(e){return n=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},n(e)}function o(e,t){return o=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},o(e,t)}function i(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function a(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,o=n(e);if(t){var a=n(this).constructor;r=Reflect.construct(o,arguments,a)}else r=o.apply(this,arguments);return function(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return i(e)}(this,r)}}function s(){return s="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var o=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=n(e)););return e}(e,t);if(o){var i=Object.getOwnPropertyDescriptor(o,t);return i.get?i.get.call(arguments.length<3?e:r):i.value}},s.apply(this,arguments)}var E=function(){function t(){e(this,t),Object.defineProperty(this,"listeners",{value:{},writable:!0,configurable:!0})}return r(t,[{key:"addEventListener",value:function(e,t,r){e in this.listeners||(this.listeners[e]=[]),this.listeners[e].push({callback:t,options:r})}},{key:"removeEventListener",value:function(e,t){if(e in this.listeners)for(var r=this.listeners[e],n=0,o=r.length;n<o;n++)if(r[n].callback===t)return void r.splice(n,1)}},{key:"dispatchEvent",value:function(e){if(e.type in this.listeners){for(var t=this.listeners[e.type].slice(),r=0,n=t.length;r<n;r++){var o=t[r];try{o.callback.call(this,e)}catch(e){Promise.resolve().then((function(){throw e}))}o.options&&o.options.once&&this.removeEventListener(e.type,o.callback)}return!e.defaultPrevented}}}]),t}(),u=function(t){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&o(e,t)}(c,t);var u=a(c);function c(){var t;return e(this,c),(t=u.call(this)).listeners||E.call(i(t)),Object.defineProperty(i(t),"aborted",{value:!1,writable:!0,configurable:!0}),Object.defineProperty(i(t),"onabort",{value:null,writable:!0,configurable:!0}),Object.defineProperty(i(t),"reason",{value:void 0,writable:!0,configurable:!0}),t}return r(c,[{key:"toString",value:function(){return"[object AbortSignal]"}},{key:"dispatchEvent",value:function(e){"abort"===e.type&&(this.aborted=!0,"function"==typeof this.onabort&&this.onabort.call(this,e)),s(n(c.prototype),"dispatchEvent",this).call(this,e)}}]),c}(E),c=function(){function t(){e(this,t),Object.defineProperty(this,"signal",{value:new u,writable:!0,configurable:!0})}return r(t,[{key:"abort",value:function(e){var t;try{t=new Event("abort")}catch(e){"undefined"!=typeof document?document.createEvent?(t=document.createEvent("Event")).initEvent("abort",!1,!1):(t=document.createEventObject()).type="abort":t={type:"abort",bubbles:!1,cancelable:!1}}var r=e;if(void 0===r)if("undefined"==typeof document)(r=new Error("This operation was aborted")).name="AbortError";else try{r=new DOMException("signal is aborted without reason")}catch(e){(r=new Error("This operation was aborted")).name="AbortError"}this.signal.reason=r,this.signal.dispatchEvent(t)}},{key:"toString",value:function(){return"[object AbortController]"}}]),t}();"undefined"!=typeof Symbol&&Symbol.toStringTag&&(c.prototype[Symbol.toStringTag]="AbortController",u.prototype[Symbol.toStringTag]="AbortSignal"),function(e){(function(e){return e.__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL?(console.log("__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL=true is set, will force install polyfill"),!0):"function"==typeof e.Request&&!e.Request.prototype.hasOwnProperty("signal")||!e.AbortController})(e)&&(e.AbortController=c,e.AbortSignal=u)}("undefined"!=typeof self?self:global)},"function"==typeof define&&define.amd?define(y):y();var w={},C="undefined"!=typeof window?"signal"in new Request("")?window.fetch:i:a,I=function(e,r){var n=this;this.send=function(e){return function(r,o){return l(n,void 0,void 0,(function(){var n,i,a,E,u,l,f,y,d,_,b,R,v,h,T,O,D,A,g,S,m,I,N,P,B,q,L,U,j,H,Y,k,F,G,M,K,Q,x,z,W,J,V,X;return p(this,(function(p){switch(p.label){case 0:n=t(this.requestObject,e),i=n.api,a=n.preUpdate,E=n.postUpdate,u=n.preError,l=n.postError,f=n.data,y=n.files,d=n.requestCancel,_=void 0===d||d,b=n.updateStore,R=void 0===b||b,v=n.fileKey,h=void 0===v?this.options.fileKey:v,T=n.primaryKey,O=void 0===T?this.options.primaryKey:T,D=n.bodyKey,A=void 0===D?this.options.bodyKey:D,g=n.method,S=void 0===g?this.options.method:g,m=n.normalize,I=void 0===m?this.options.normalize:m,N=n.mergeListStrategy,P=void 0===N?this.options.mergeListStrategy:N,B=n.headers,q=void 0===B?this.options.headers:B,L=n.responseKeyCode,U=void 0===L?this.options.responseKeyCode:L,j=Math.random().toString(36).substr(2),H=new Date,p.label=1;case 1:if(p.trys.push([1,4,,5]),Y=JSON.stringify(c(c({},f),{requestID:j})),k=new AbortController,F=k.signal,r({type:s.CDEEBEE_REQUESTMANAGER_SET,payload:{requestID:j,api:i,controller:k,data:f,requestCancel:_,requestStartTime:H,requestEndTime:void 0}}),y){for(G=new FormData,M=0;M<y.length;M+=1)h&&G.append(h,y[M]);A&&G.append(A,Y),Y=G}return[4,C(i,{method:S,signal:F,headers:c({"ui-request-id":j},q),body:Y})];case 2:return[4,p.sent().json()];case 3:if(K=p.sent())for(w=Object.assign(((J={})[j]={response:K,requestApi:i,requestStartTime:H,preUpdate:a,postUpdate:E,normalize:I,preError:u,postError:l,mergeListStrategy:P},J),w);w[null===(X=null===(V=o().requestManager.activeRequest)||void 0===V?void 0:V[0])||void 0===X?void 0:X.requestID];)Q=o().requestManager.activeRequest[0].requestID,x=w[Q],delete w[Q],U&&0===x.response[U]?(x.preUpdate&&x.preUpdate(x.response),R&&r({type:s.CDEEBEEE_UPDATE,payload:{response:x.normalize instanceof Function&&x.normalize({response:x.response,cdeebee:o().cdeebee,mergeListStrategy:x.mergeListStrategy,primaryKey:O}),cleanResponse:x.response,api:x.requestApi,mergeListStrategy:x.mergeListStrategy}}),x.postUpdate&&x.postUpdate(x.response)):(x.preError&&x.preError(x.response),r({type:s.CDEEBEE_ERRORHANDLER_SET,payload:{api:x.requestApi,cleanResponse:x.response}}),x.postError&&x.postError(K)),r({type:s.CDEEBEE_REQUESTMANAGER_SHIFT,payload:{requestID:j,api:x.requestApi,controller:k,data:f,requestCancel:_,requestStartTime:x.requestStartTime,requestEndTime:new Date}});return[3,5];case 4:return"AbortError"===(z=p.sent()).name?r({type:s.CDEEBEE_REQUEST_ABORTED,payload:{requestID:j,api:i}}):(W=new Date,r({type:s.CDEEBEE_INTERNAL_ERROR,payload:{requestStartTime:H,requestEndTime:W,requestID:j,api:i}}),console.warn("@@makeRequest-error",z),console.warn("@@makeRequest-object",t(this.requestObject,e)),console.warn("@@makeRequest-info",{requestStartTime:H,requestEndTime:W,requestID:j}),this.options.hasOwnProperty("globalErrorHandler")&&this.options.globalErrorHandler instanceof Function&&this.options.globalErrorHandler(z,t(this.requestObject,e),{requestStartTime:H,requestEndTime:W,requestID:j})(r,o)),[3,5];case 5:return[2]}}))}))}},this.requestObject=e,this.options=c({fileKey:"files",bodyKey:"body",method:"POST",primaryKey:"primaryKey",normalize:O,responseKeyCode:"responseStatus",headers:{"content-type":"application/json"}},r)};var N=Object.freeze({__proto__:null,unsafe_updateStore:function(e,t,r){return function(n){n({type:s.CDEEBEE_ENTITY_UNSAFE_UPDATE_STORE,payload:{entityList:e,entityID:t,value:r}})}},setKeyValue:function(e,t,r){return function(n){n({type:s.CDEEBEE_ENTITY_CHANGE_FIELD,payload:{entityList:e,entityID:t,valueList:r}})}},commitEntity:function(e,t,r){return function(n){n({type:s.CDEEBEE_SET_ENTITY,payload:{entityList:e,entityID:t,entity:r}})}},resetEntity:function(e,t){return function(r){r({type:s.CDEEBEE_RESET_ENTITY,payload:{entityList:e,entityID:t}})}},dropCdeebeePath:function(e){return function(t){return t({type:s.CDEEBEEE_DROP_PATH,payload:{path:e}})}},dropRequestByApiUrl:function(e){return function(t){return t({type:s.CDEEBEEE_DROP_REQUEST_BY_API_URL,payload:{api:e}})}},dropErrorsByApiUrl:function(e){return function(t){return t({type:s.CDEEBEEE_DROP_ERROR_BY_API_URL,payload:{api:e}})}}});export{I as CdeebeeRequest,g as cdeebee,N as cdeebeeActions,E as cdeebeeEntityState,D as cdeebeeHelpers,u as cdeebeeMergeStrategy,s as cdeebeeTypes,m as requestManager};
//# sourceMappingURL=index.esm.js.map

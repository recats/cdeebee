!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("ramda"),require("whatwg-fetch"),require("node-fetch")):"function"==typeof define&&define.amd?define(["exports","ramda","whatwg-fetch","node-fetch"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).cdeebee={},e.ramda,e.whatwgFetch,e.nodeFetch)}(this,(function(e,t,r,n){"use strict";function o(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var i,a,s,c=o(n),E=function(){return E=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},E.apply(this,arguments)};function u(e,t,r,n){return new(r||(r=Promise))((function(o,i){function a(e){try{c(n.next(e))}catch(e){i(e)}}function s(e){try{c(n.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,s)}c((n=n.apply(e,t||[])).next())}))}function l(e,t){var r,n,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(s){return function(c){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;i&&(i=0,s[0]&&(a=0)),a;)try{if(r=1,n&&(o=2&s[0]?n.return:s[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,s[1])).done)return o;switch(n=0,o&&(s=[2&s[0],o.value]),s[0]){case 0:case 1:o=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,n=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!o||s[1]>o[0]&&s[1]<o[3])){a.label=s[1];break}if(6===s[0]&&a.label<o[1]){a.label=o[1],o=s;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(s);break}o[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],n=0}finally{r=o=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}}function p(e,t,r){if(r||2===arguments.length)for(var n,o=0,i=t.length;o<i;o++)!n&&o in t||(n||(n=Array.prototype.slice.call(t,0,o)),n[o]=t[o]);return e.concat(n||Array.prototype.slice.call(t))}e.cdeebeeTypes=void 0,(i=e.cdeebeeTypes||(e.cdeebeeTypes={})).CDEEBEE_REQUESTMANAGER_SHIFT="@@cdeebee/REQUESTMANAGER_SHIFT",i.CDEEBEE_REQUESTMANAGER_SET="@@cdeebee/REQUESTMANAGER_SET",i.CDEEBEE_ERRORHANDLER_SET="@@cdeebee/ERRORHANDLER_SET",i.CDEEBEE_ENTITY_CHANGE_FIELD="@@cdeebee/ENTITY_CHANGE_FIELD",i.CDEEBEE_ENTITY_UNSAFE_UPDATE_STORE="@@cdeebee/ENTITY_UNSAFE_UPDATE_STORE",i.CDEEBEE_RESET_ENTITY="@@cdeebee/RESET_ENTITY",i.CDEEBEE_SET_ENTITY="@@cdeebee/SET_ENTITY",i.CDEEBEEE_UPDATE="@@cdeebee/UPDATE",i.CDEEBEEE_DROP="@@cdeebee/DROP",i.CDEEBEEE_DROP_PATH="@@cdeebee/DROP_PATH",i.CDEEBEE_INTERNAL_ERROR="@@cdeebee/INTERNAL_ERROR",i.CDEEBEE_REQUEST_ABORTED="@@cdeebee/REQUEST_ABORTED",i.CDEEBEEE_DROP_REQUEST_BY_API_URL="@@cdeebee/DROP_REQUEST_BY_API_URL",i.CDEEBEEE_DROP_ERROR_BY_API_URL="@@cdeebee/DROP_ERROR_BY_API_URL",i.CHANGE_ROUTE="@@router/LOCATION_CHANGE",e.cdeebeeEntityState=void 0,(a=e.cdeebeeEntityState||(e.cdeebeeEntityState={})).NEW="NEW",a.EDITING="EDITING",a.NORMAL="NORMAL",e.cdeebeeMergeStrategy=void 0,(s=e.cdeebeeMergeStrategy||(e.cdeebeeMergeStrategy={})).merge="merge",s.replace="replace";var y,d=function(e){return t.omit(["__entity","__state"],e)},f=function(e){return e.filter((function(e){return!e.requestCancel||(b(e),!1)}))},b=function(e){e.controller&&e.controller.abort instanceof Function&&e.controller.abort()},_=function(t){var r,n=(null===(r=null==t?void 0:t.__entity)||void 0===r?void 0:r.__state)||(null==t?void 0:t.__state);return n||e.cdeebeeEntityState.NORMAL},T=function(t){return _(t)===e.cdeebeeEntityState.NORMAL?(console.warn("reset works only in editing and new states"),t):d(t)},R=function(r,n,o){var i=r[n];if(_(i[o])===e.cdeebeeEntityState.EDITING)return r;var a=t.assocPath([n,o,"__entity"],i[o],r);return t.assocPath([n,o,"__entity","__state"],e.cdeebeeEntityState.EDITING,a)},h=function(e,r,n){for(var o=n||[],i=e,a=0;a<r.length;a++){var s=r[a];i=t.assocPath(p(p([],o,!0),s.key,!0),s.value,i)}return i},v=function(r){var n=r.response;n.responseStatus;for(var o=function(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(n=Object.getOwnPropertySymbols(e);o<n.length;o++)t.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(e,n[o])&&(r[n[o]]=e[n[o]])}return r}(n,["responseStatus"]),i=r.cdeebee,a=r.mergeListStrategy,s=r.primaryKey,c=0,E=Object.keys(o);c<E.length;c++){var u=E[c],l={};if(o[u]instanceof Object&&o[u].hasOwnProperty(s)){for(var p=0,y=o[u].data;p<y.length;p++){var d=y[p];l[d[o[u][s]]]=d}a[u]===e.cdeebeeMergeStrategy.replace?o[u]=l:o[u]=t.mergeDeepRight(i[u],l)}else null!==o[u]&&void 0!==o[u]&&"string"!=typeof o[u]||(o=t.omit([u],o))}return o},D=Object.freeze({__proto__:null,dropRequestFromArray:f,requestCancel:b,checkNetworkActivity:function(e,t){if(!t||0===e.length)return!1;for(var r=t instanceof Array?t:[t],n=e.map((function(e){return e.api})),o=0;o<r.length;o+=1)if(n.includes(r[o]))return!0;return!1},getSubEntity:function(e){return Object.prototype.hasOwnProperty.call(e,"__entity")?e.__entity:e},getEntityState:_,insertEntity:function(t){return t.__state=e.cdeebeeEntityState.NEW,t},commitEntity:function(t){return _(t)===e.cdeebeeEntityState.NORMAL?(console.warn("commit works only in editing and new states"),t):d(t)},resetEntity:T,editEntity:R,batchingUpdate:h,defaultNormalize:v}),g={},O={activeRequest:[],requestByApiUrl:{},errorHandler:{}};y=function(){function e(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function t(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function r(e,r,n){return r&&t(e.prototype,r),n&&t(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function n(e){return n=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},n(e)}function o(e,t){return o=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},o(e,t)}function i(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function a(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,o=n(e);if(t){var a=n(this).constructor;r=Reflect.construct(o,arguments,a)}else r=o.apply(this,arguments);return function(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return i(e)}(this,r)}}function s(){return s="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var o=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=n(e)););return e}(e,t);if(o){var i=Object.getOwnPropertyDescriptor(o,t);return i.get?i.get.call(arguments.length<3?e:r):i.value}},s.apply(this,arguments)}var c=function(){function t(){e(this,t),Object.defineProperty(this,"listeners",{value:{},writable:!0,configurable:!0})}return r(t,[{key:"addEventListener",value:function(e,t,r){e in this.listeners||(this.listeners[e]=[]),this.listeners[e].push({callback:t,options:r})}},{key:"removeEventListener",value:function(e,t){if(e in this.listeners)for(var r=this.listeners[e],n=0,o=r.length;n<o;n++)if(r[n].callback===t)return void r.splice(n,1)}},{key:"dispatchEvent",value:function(e){if(e.type in this.listeners){for(var t=this.listeners[e.type].slice(),r=0,n=t.length;r<n;r++){var o=t[r];try{o.callback.call(this,e)}catch(e){Promise.resolve().then((function(){throw e}))}o.options&&o.options.once&&this.removeEventListener(e.type,o.callback)}return!e.defaultPrevented}}}]),t}(),E=function(t){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&o(e,t)}(u,t);var E=a(u);function u(){var t;return e(this,u),(t=E.call(this)).listeners||c.call(i(t)),Object.defineProperty(i(t),"aborted",{value:!1,writable:!0,configurable:!0}),Object.defineProperty(i(t),"onabort",{value:null,writable:!0,configurable:!0}),Object.defineProperty(i(t),"reason",{value:void 0,writable:!0,configurable:!0}),t}return r(u,[{key:"toString",value:function(){return"[object AbortSignal]"}},{key:"dispatchEvent",value:function(e){"abort"===e.type&&(this.aborted=!0,"function"==typeof this.onabort&&this.onabort.call(this,e)),s(n(u.prototype),"dispatchEvent",this).call(this,e)}}]),u}(c),u=function(){function t(){e(this,t),Object.defineProperty(this,"signal",{value:new E,writable:!0,configurable:!0})}return r(t,[{key:"abort",value:function(e){var t;try{t=new Event("abort")}catch(e){"undefined"!=typeof document?document.createEvent?(t=document.createEvent("Event")).initEvent("abort",!1,!1):(t=document.createEventObject()).type="abort":t={type:"abort",bubbles:!1,cancelable:!1}}var r=e;if(void 0===r)if("undefined"==typeof document)(r=new Error("This operation was aborted")).name="AbortError";else try{r=new DOMException("signal is aborted without reason")}catch(e){(r=new Error("This operation was aborted")).name="AbortError"}this.signal.reason=r,this.signal.dispatchEvent(t)}},{key:"toString",value:function(){return"[object AbortController]"}}]),t}();"undefined"!=typeof Symbol&&Symbol.toStringTag&&(u.prototype[Symbol.toStringTag]="AbortController",E.prototype[Symbol.toStringTag]="AbortSignal"),function(e){(function(e){return e.__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL?(console.log("__FORCE_INSTALL_ABORTCONTROLLER_POLYFILL=true is set, will force install polyfill"),!0):"function"==typeof e.Request&&!e.Request.prototype.hasOwnProperty("signal")||!e.AbortController})(e)&&(e.AbortController=u,e.AbortSignal=E)}("undefined"!=typeof self?self:global)},"function"==typeof define&&define.amd?define(y):y();var S={},A="undefined"!=typeof window?"signal"in new Request("")?window.fetch:r.fetch:c.default,m=function(r,n){var o=this;this.send=function(r){return function(n,i){return u(o,void 0,void 0,(function(){var o,a,s,c,u,p,y,d,f,b,_,T,R,h,v,D,g,O,m,w,P,C,I,N,q,B,L,U,j,H,Y,k,F,M,G,K,Q,x,z,W,J,V,X;return l(this,(function(l){switch(l.label){case 0:o=t.mergeDeepRight(this.requestObject,r),a=o.api,s=o.preUpdate,c=o.postUpdate,u=o.preError,p=o.postError,y=o.data,d=o.files,f=o.requestCancel,b=void 0===f||f,_=o.updateStore,T=void 0===_||_,R=o.fileKey,h=void 0===R?this.options.fileKey:R,v=o.primaryKey,D=void 0===v?this.options.primaryKey:v,g=o.bodyKey,O=void 0===g?this.options.bodyKey:g,m=o.method,w=void 0===m?this.options.method:m,P=o.normalize,C=void 0===P?this.options.normalize:P,I=o.mergeListStrategy,N=void 0===I?this.options.mergeListStrategy:I,q=o.headers,B=void 0===q?this.options.headers:q,L=o.responseKeyCode,U=void 0===L?this.options.responseKeyCode:L,j=Math.random().toString(36).substr(2),H=new Date,l.label=1;case 1:if(l.trys.push([1,4,,5]),Y=JSON.stringify(E(E({},y),{requestID:j})),k=new AbortController,F=k.signal,n({type:e.cdeebeeTypes.CDEEBEE_REQUESTMANAGER_SET,payload:{requestID:j,api:a,controller:k,data:y,requestCancel:b,requestStartTime:H,requestEndTime:void 0}}),d){for(M=new FormData,G=0;G<d.length;G+=1)h&&M.append(h,d[G]);O&&M.append(O,Y),Y=M}return[4,A(a,{method:w,signal:F,headers:E({"ui-request-id":j},B),body:Y})];case 2:return[4,l.sent().json()];case 3:if(K=l.sent())for(S=Object.assign(((J={})[j]={response:K,requestApi:a,requestStartTime:H,preUpdate:s,postUpdate:c,normalize:C,preError:u,postError:p,mergeListStrategy:N},J),S);S[null===(X=null===(V=i().requestManager.activeRequest)||void 0===V?void 0:V[0])||void 0===X?void 0:X.requestID];)Q=i().requestManager.activeRequest[0].requestID,x=S[Q],delete S[Q],U&&0===x.response[U]?(x.preUpdate&&x.preUpdate(x.response),T&&n({type:e.cdeebeeTypes.CDEEBEEE_UPDATE,payload:{response:x.normalize instanceof Function&&x.normalize({response:x.response,cdeebee:i().cdeebee,mergeListStrategy:x.mergeListStrategy,primaryKey:D}),cleanResponse:x.response,api:x.requestApi,mergeListStrategy:x.mergeListStrategy}}),x.postUpdate&&x.postUpdate(x.response)):(x.preError&&x.preError(x.response),n({type:e.cdeebeeTypes.CDEEBEE_ERRORHANDLER_SET,payload:{api:x.requestApi,cleanResponse:x.response}}),x.postError&&x.postError(K)),n({type:e.cdeebeeTypes.CDEEBEE_REQUESTMANAGER_SHIFT,payload:{requestID:j,api:x.requestApi,controller:k,data:y,requestCancel:b,requestStartTime:x.requestStartTime,requestEndTime:new Date}});return[3,5];case 4:return"AbortError"===(z=l.sent()).name?n({type:e.cdeebeeTypes.CDEEBEE_REQUEST_ABORTED,payload:{requestID:j,api:a}}):(W=new Date,n({type:e.cdeebeeTypes.CDEEBEE_INTERNAL_ERROR,payload:{requestStartTime:H,requestEndTime:W,requestID:j,api:a}}),console.warn("@@makeRequest-error",z),console.warn("@@makeRequest-object",t.mergeDeepRight(this.requestObject,r)),console.warn("@@makeRequest-info",{requestStartTime:H,requestEndTime:W,requestID:j}),this.options.hasOwnProperty("globalErrorHandler")&&this.options.globalErrorHandler instanceof Function&&this.options.globalErrorHandler(z,t.mergeDeepRight(this.requestObject,r),{requestStartTime:H,requestEndTime:W,requestID:j})(n,i)),[3,5];case 5:return[2]}}))}))}},this.requestObject=r,this.options=E({fileKey:"files",bodyKey:"body",method:"POST",primaryKey:"primaryKey",normalize:v,responseKeyCode:"responseStatus",headers:{"content-type":"application/json"}},n)};var w=Object.freeze({__proto__:null,unsafe_updateStore:function(t,r,n){return function(o){o({type:e.cdeebeeTypes.CDEEBEE_ENTITY_UNSAFE_UPDATE_STORE,payload:{entityList:t,entityID:r,value:n}})}},setKeyValue:function(t,r,n){return function(o){o({type:e.cdeebeeTypes.CDEEBEE_ENTITY_CHANGE_FIELD,payload:{entityList:t,entityID:r,valueList:n}})}},commitEntity:function(t,r,n){return function(o){o({type:e.cdeebeeTypes.CDEEBEE_SET_ENTITY,payload:{entityList:t,entityID:r,entity:n}})}},resetEntity:function(t,r){return function(n){n({type:e.cdeebeeTypes.CDEEBEE_RESET_ENTITY,payload:{entityList:t,entityID:r}})}},dropCdeebeePath:function(t){return function(r){return r({type:e.cdeebeeTypes.CDEEBEEE_DROP_PATH,payload:{path:t}})}},dropRequestByApiUrl:function(t){return function(r){return r({type:e.cdeebeeTypes.CDEEBEEE_DROP_REQUEST_BY_API_URL,payload:{api:t}})}},dropErrorsByApiUrl:function(t){return function(r){return r({type:e.cdeebeeTypes.CDEEBEEE_DROP_ERROR_BY_API_URL,payload:{api:t}})}}});e.CdeebeeRequest=m,e.cdeebee=function(r,n){void 0===r&&(r=g);var o=n.type,i=n.payload;switch(o){case e.cdeebeeTypes.CDEEBEEE_UPDATE:return E(E({},r),i.response);case e.cdeebeeTypes.CDEEBEE_ENTITY_CHANGE_FIELD:var a=R(r,i.entityList,i.entityID);return h(a,i.valueList,[i.entityList,i.entityID,"__entity"]);case e.cdeebeeTypes.CDEEBEE_ENTITY_UNSAFE_UPDATE_STORE:return t.assocPath([i.entityList,i.entityID],i.value,r);case e.cdeebeeTypes.CDEEBEE_SET_ENTITY:return t.assocPath([i.entityList,i.entityID],i.entity,r);case e.cdeebeeTypes.CDEEBEE_RESET_ENTITY:var s=r[i.entityList];return t.assocPath([i.entityList,i.entityID],T(s[i.entityID]),r);case e.cdeebeeTypes.CDEEBEEE_DROP:return g;case e.cdeebeeTypes.CDEEBEEE_DROP_PATH:return t.omit(i.path,r);default:return r}},e.cdeebeeActions=w,e.cdeebeeHelpers=D,e.requestManager=function(r,n){var o,i;void 0===r&&(r=O);var a=n.type,s=n.payload;switch(a){case e.cdeebeeTypes.CDEEBEE_REQUESTMANAGER_SET:return E(E({},r),{activeRequest:p(p([],r.activeRequest,!0),[s],!1)});case e.cdeebeeTypes.CDEEBEE_REQUESTMANAGER_SHIFT:return E(E({},r),{activeRequest:t.slice(1,1/0,r.activeRequest)});case e.cdeebeeTypes.CDEEBEEE_UPDATE:return E(E({},r),{requestByApiUrl:E(E({},r.requestByApiUrl),(o={},o[s.api]=s.cleanResponse,o))});case e.cdeebeeTypes.CDEEBEEE_DROP_REQUEST_BY_API_URL:return E(E({},r),{requestByApiUrl:t.dissoc(s.api,r.requestByApiUrl)});case e.cdeebeeTypes.CDEEBEEE_DROP_ERROR_BY_API_URL:return E(E({},r),{errorHandler:t.dissoc(s.api,r.errorHandler)});case e.cdeebeeTypes.CDEEBEE_ERRORHANDLER_SET:return E(E({},r),{errorHandler:E(E({},r.errorHandler),(i={},i[s.api]=s.cleanResponse,i))});case e.cdeebeeTypes.CDEEBEE_INTERNAL_ERROR:return E(E({},r),{activeRequest:[],requestByApiUrl:{}});case e.cdeebeeTypes.CHANGE_ROUTE:return E(E({},O),{activeRequest:f(r.activeRequest)});default:return r}},Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=index.umd.js.map
